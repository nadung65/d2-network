<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D2 Network - Video Call</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
      }

      .container {
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        background-color: black;
      }

      #remoteVideo {
        width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      #localVideo {
        position: absolute;
        top: 16px;
        left: 16px;
        max-width: 150px;
        border-radius: 16px;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    
    <div class="container">
      <video playsinline autoplay id="remoteVideo"></video>
      <video playsinline autoplay id="localVideo"></video>
    </div>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, addDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyClJCr_QB9ZDir5fLDiBum42qVGZhnUgmo",
        authDomain: "d2-network.firebaseapp.com",
        databaseURL: "https://d2-network-default-rtdb.firebaseio.com",
        projectId: "d2-network",
        storageBucket: "d2-network.appspot.com",
        messagingSenderId: "439403588318",
        appId: "1:439403588318:web:0f0617f5375adeed3e304f"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
    </script>

    <script>
      let peer;
      let peerList = [];
      let localStream;
      
      const paramString = (window.location.search).substring(1);
      console.log(paramString);
      
      // Nếu nhận được remoteID từ người nhận
      if (paramString.startsWith('id=')) {
        const remotePeerID = paramString.substring(3);
        console.log('remotePeerID:', remotePeerID);
        
        peer = new Peer();

        peer.on('open', id => {
          if (!navigator.mediaDevices) {
            console.log('Not supported');
            return;
          }

          console.log('#' + id);

          navigator.mediaDevices
            .getUserMedia({video: true, audio: true})
            .then(async stream => {
              localStream = stream;
              addLocalVideo(stream);

              startCall(remotePeerID);
            });
        });
      } else if (paramString === 'action=init') {
        peer = new Peer();

        peer.on('open', id => {
          if (!navigator.mediaDevices) {
            console.log('Not supported');
            return;
          }

          console.log('#' + id);

          addDoc(doc(db, '/test/ahihi'), {
            inCall: id
          }).then(() => {
            console.log('listening');
            
            navigator.mediaDevices
              .getUserMedia({video: true, audio: true})
              .then(async stream => {
                localStream = stream;
                addLocalVideo(stream);

                listen()
              });
          })
        });
      }

      const listen = () => {
        peer.on('call', call => {
          call.answer(localStream);
          call.on('stream', remoteStream => {
            if (!peerList.includes(call.peer)) {
              addRemoteVideo(remoteStream);
              peerList.push(call.peer);
            }
          });
        });

        return true;
      };

      const startCall = (remotePeerID) => {
        let call = peer.call(remotePeerID, localStream);
        call &&
          call.on('stream', remoteStream => {
            if (!peerList.includes(call.peer)) {
              addRemoteVideo(remoteStream);
              peerList.push(call.peer);
              currentPeer = call.peerConnection;
            }
          });

        return true;
      };

      const addLocalVideo = stream => {
        document.getElementById('localVideo').srcObject = stream;

        return true;
      };

      const addRemoteVideo = stream => {
        document.getElementById('remoteVideo').srcObject = stream;

        return true;
      };

      const toggleVideo = boolean => {
        localStream.getVideoTracks()[0].enabled = boolean;

        return true;
      };

      const toggleAudio = boolean => {
        localStream.getAudioTracks()[0].enabled = boolean;

        return true;
      };
    </script>
  </body>
</html>
